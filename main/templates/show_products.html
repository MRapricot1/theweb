<script>
// Configuration (pakai id product dari context view)
const PRODUCT_ID =" {{ products.id }}"
const PRODUCT_DETAIL_ENDPOINT = `{% url 'main:show_json_by_id' 0 %}`.replace('0', PRODUCT_ID);

// DOM Elements (id mengikuti template tutorial)
const loadingState = document.getElementById('loading-state') || document.getElementById('loading');
const errorState = document.getElementById('error-state') || document.getElementById('error');
const articleContent = document.getElementById('article-content') || document.getElementById('content');
const badgesContainer = document.getElementById('badges-container') || document.getElementById('badges');
const articleTitle = document.getElementById('article-title') || document.getElementById('title');
const articleDate = document.getElementById('article-date'); // boleh null
const articleViews = document.getElementById('article-views') || document.getElementById('views');
const featuredImageContainer = document.getElementById('featured-image-container') || document.getElementById('thumb-wrap');
const featuredImage = document.getElementById('featured-image') || document.getElementById('thumb');
const articleContentText = document.getElementById('article-content-text') || document.getElementById('desc');
const articleAuthor = document.getElementById('article-author') || document.getElementById('author');

// Show/hide page sections
function showState(state) {
  if (loadingState) loadingState.classList.toggle('hidden', state !== 'loading');
  if (errorState) errorState.classList.toggle('hidden', state !== 'error');
  if (articleContent) articleContent.classList.toggle('hidden', state !== 'ready');
}

// Get readable category name (sesuaikan dengan CATEGORY_CHOICES Product)
function getCategoryLabel(code) {
  const map = { update: 'Update', jersey: 'Jersey', socks: 'Socks', ball: 'Ball' };
  return map[code] || code || 'General';
}

// Escape HTML
function esc(s) {
  return String(s ?? '').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}

// Render product content
function renderProduct(prod) {
  // Title
  if (articleTitle) articleTitle.textContent = prod.name;
  document.title = `${prod.name} - The Web`;

  // Badges
  if (badgesContainer) {
    badgesContainer.innerHTML = '';

    // Category
    const cat = document.createElement('span');
    cat.className = 'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-emerald-700 text-white';
    cat.textContent = getCategoryLabel(prod.category);
    badgesContainer.appendChild(cat);

    // Featured
    if (prod.is_featured) {
      const f = document.createElement('span');
      f.className = 'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-yellow-100 text-yellow-800';
      f.textContent = 'Featured';
      badgesContainer.appendChild(f);
    }

    // Hot (>= 21 views)
    if ((prod.products_views || 0) > 20) {
      const h = document.createElement('span');
      h.className = 'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-red-100 text-red-800';
      h.textContent = 'Hot';
      badgesContainer.appendChild(h);
    }
  }

  // Date (Product tidak punya created_at â†’ sembunyikan jika elemen ada)
  if (articleDate) {
    articleDate.textContent = '';
    articleDate.parentElement?.classList?.add('hidden'); // sembunyikan wrapper
  }

  // Views
  if (articleViews) {
    articleViews.textContent = `${prod.products_views ?? 0} views`;
  }

  // Image
  if (featuredImage && featuredImageContainer) {
    if (prod.thumbnail) {
      featuredImage.src = prod.thumbnail;
      featuredImage.alt = prod.name;
      featuredImageContainer.classList.remove('hidden');
    } else {
      featuredImageContainer.classList.add('hidden');
    }
  }

  // Content/Description
  if (articleContentText) {
    articleContentText.textContent = prod.description || '';
  }

  // Author
  if (articleAuthor) {
    const authorName = prod.user_username || 'Anonymous';
    articleAuthor.textContent = `Author: ${authorName}`;
  }
}

// Normalisasi data (dukung JsonResponse datar & serializers lama)
function normalize(raw) {
  // A) JsonResponse datar (disarankan)
  if (raw && raw.id !== undefined && raw.name !== undefined) return raw;

  // B) serializers.serialize -> array berisi 1 elemen
  if (Array.isArray(raw) && raw.length) {
    const it = raw[0];
    const f = it.fields || {};
    return {
      id: it.pk,
      name: f.name,
      description: f.description || '',
      category: f.category || null,
      thumbnail: f.thumbnail || null,
      products_views: f.products_views || 0,
      is_featured: !!f.is_featured,
      user_username: null,
    };
  }
  return {};
}

// Fetch product detail
async function loadProductDetail() {
  try {
    showState('loading');
    const resp = await fetch(PRODUCT_DETAIL_ENDPOINT, { headers: { 'Accept': 'application/json' } });
    if (!resp.ok) throw new Error('Failed to fetch product detail');
    const data = await resp.json();
    const product = normalize(data);
    renderProduct(product);
    showState('ready');
  } catch (err) {
    console.error('Error loading product detail:', err);
    showState('error');
  }
}

// Init
loadProductDetail();
</script>
